unit Main;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics,
  Controls, Forms, uniGUITypes, uniGUIAbstractClasses,
  uniGUIClasses, uniGUIRegClasses, uniGUIForm, Vcl.Menus, uniMainMenu,
  uniGUIFrame, FrameBarraMain, uniLabel, Vcl.Imaging.pngimage, uniImage,
  uniGUIBaseClasses, uniPanel, uniPageControl, uniTreeView, uniTreeMenu,
  uniImageList, Vcl.Imaging.jpeg, FrameBarraNavegacionPrincipal;

type
  TMainForm = class(TUniForm)
    PanelGeneralIzquierda: TUniPanel;
    PanelLogotipo: TUniPanel;
    imgLogotipo: TUniImage;
    lblTituloAplicacion: TUniLabel;
    lblVersion: TUniLabel;
    PanelSeparacionMenu0: TUniPanel;
    PanelMenuPrincipal: TUniPanel;
    PanelSeparacionMenu7: TUniPanel;
    UniTreeMenu: TUniTreeMenu;
    MenuPrincipalBotom: TUniPanel;
    PanelLinea: TUniPanel;
    mnuPanelAcerca: TUniPanel;
    lnkAcercaPlataformaTramiteWeb: TUniLabel;
    PanelTopUsuario: TUniPanel;
    lblNombreApellidoUsuario: TUniLabel;
    lblOrganigramaUsuario: TUniLabel;
    imgOrganigrama: TUniImage;
    UniContainerPanel: TUniContainerPanel;
    imgFotoUsuario: TUniImage;
    UniMenuItems1: TUniMenuItems;
    HolaMundo1: TUniMenuItem;
    lblCerrarSesion: TUniLabel;
    imgLogout: TUniImage;
    mnuHerramientas: TUniMenuItem;
    mnuHerramientasFicheroUsuario: TUniMenuItem;
    UniNativeImageList: TUniNativeImageList;
    mnuHerramientasOrganizacion: TUniMenuItem;
    mnuFicheros: TUniMenuItem;
    mnuFicherosArticulos: TUniMenuItem;
    mnuOperaciones: TUniMenuItem;
    Operacionesdeentrada1: TUniMenuItem;
    Operacionesdesalida1: TUniMenuItem;
    mnuFicherosArticulosFicha: TUniMenuItem;
    PanelDerecha: TUniPanel;
    PanelHbox: TUniPanel;
    PanelVbox: TUniPanel;
    PanelVentana: TUniPanel;
    UniPageControl1: TUniPageControl;
    UniTabSheet1: TUniTabSheet;
    UniContainerPanel1: TUniContainerPanel;
    UniImage1: TUniImage;
    UniImageList1: TUniImageList;
    procedure UniFormShow(Sender: TObject);
    procedure mnuHerramientasOrganizacionClick(Sender: TObject);
    procedure Usuarios1Click(Sender: TObject);
    procedure UniFormAfterShow(Sender: TObject);
    procedure Organizacin1Click(Sender: TObject);
    procedure UniFormCreate(Sender: TObject);
    procedure mnuHerramientasFicheroUsuarioClick(Sender: TObject);
    procedure lblCerrarSesionClick(Sender: TObject);
    procedure mnuFicherosArticulosFichaClick(Sender: TObject);
    procedure TabSheetClose(Sender: TObject; var AllowClose: Boolean);

  private
    { Private declarations }
  procedure CreaMenu(Formulario:TUniForm);
  public
    { Public declarations }
  end;

function MainForm: TMainForm;

implementation

{$R *.dfm}

uses
  uniGUIVars, MainModule, uniGUIApplication, FormularioUsuario, FormularioCRUDMaestro, UnitCodigosComunesFormulario, FormularioOrganizacion, UnitArchivos, UnitVersion, DataModuleUsuario,
  UnitOperacionesFotografia, FormularioFicheroArticulo, FrameFicheroArticulos, UnitMenuEventos;

function MainForm: TMainForm;
begin
  Result := TMainForm(UniMainModule.GetFormInstance(TMainForm));
end;

procedure TMainForm.CreaMenu(Formulario: TUniForm);
var
Ts : TUniTabSheet;
Nd : TUniTreeNode;
begin
  Nd := UniTreeMenu.Selected;

  if Nd.Count = 0 then
   begin
   Ts := Nd.Data;
   if not Assigned(Ts) then
   Begin
    //Creo el nuevo tab
    Ts := TUniTabSheet.Create(Self);
    Ts.PageControl :=UniPageControl1;
    //le doy los atributos que va a mostrar
    Ts.Name:=Formulario.name;
    Ts.Closable := True;
    Ts.OnClose := TabSheetClose;
    Ts.Tag := NativeInt(Nd);
    Ts.Caption:=Formulario.Caption;

    Formulario.Parent :=TS;
    //Paso esta variable para que no se cree un tab mas si ya esta abierto
    Nd.Data:=Ts;
   end;
   UniPageControl1.ActivePage:=Ts;
   end;
end;

procedure TMainForm.lblCerrarSesionClick(Sender: TObject);
begin
  UniApplication.UniSession.Logout;
  UniApplication.Restart;
end;

procedure TMainForm.mnuFicherosArticulosFichaClick(Sender: TObject);
begin
  if DMUsuario.VerificarPrivilegios(TUniMenuItem(Sender).Name) = True then
  begin
  CreaMenu(FrmFicheroArticulos);
  end;
end;

procedure TMainForm.mnuHerramientasFicheroUsuarioClick(Sender: TObject);
begin
  if DMUsuario.VerificarPrivilegios(TUniMenuItem(Sender).Name) = True then
  begin
  FrmUsuario.Show();
  end;
end;

procedure TMainForm.mnuHerramientasOrganizacionClick(Sender: TObject);
begin
FrmOrganizacion.Show;
end;

procedure TMainForm.Organizacin1Click(Sender: TObject);
begin
FrmOrganizacion.Show;
end;

procedure TMainForm.TabSheetClose(Sender: TObject; var AllowClose: Boolean);
var
  Ts : TUniTabSheet;
  Nd : TUniTreeNode;
begin
  Ts := Sender as TUniTabSheet;
  Nd := Pointer(Ts.Tag);
  if Assigned(Nd) then
  begin
    Nd.Data := nil;
    if UniTreeMenu.Selected = Nd then
      UniTreeMenu.Selected := nil;
  end;
end;

procedure TMainForm.UniFormAfterShow(Sender: TObject);
begin
     // CargarIndicadorDemo(TClasePanel(PanelModoDemo));
end;

procedure TMainForm.UniFormCreate(Sender: TObject);
begin
//Version de la aplicacion
lblVersion.Caption := 'Versión ' + ObtenerVersionApp;
  // Creo el Arbol de menus
  Arbol := TNode<TMenuItemRecord>.Create;
  CargarMenuEstandar(UniMenuItems1.Items);
end;

procedure TMainForm.UniFormShow(Sender: TObject);
begin
  // Nombre de usuario
  lblNombreApellidoUsuario.Caption := DMUsuario.UsuarioRecord.NombresApellidos +' '+ DMUsuario.UsuarioRecord.OcultarMenuSinAcceso.ToString();


  //Ocultos los datos innecesarios por el momento
  lblOrganigramaUsuario.Visible:= False;
  imgOrganigrama.Visible:=False;

  // Cargo la foto de la ficha del personal, si no tiene en formato estandar,
  if Assigned(DMUsuario.UsuarioRecord.Foto) then
  begin
    if DMUsuario.UsuarioRecord.Foto.IsNull = False then
    begin
      CargarFotoPerfil(TImagePerfil(imgFotoUsuario));
    end;
  end
  else
    begin
     // CargarFotoPerfil(TImagePerfil(imgFotoUsuario), DMUsuario.UsuarioRecord.IdPersonal);
    end;

     if DMUsuario.UsuarioRecord.OcultarMenuSinAcceso = True then
     begin
      OcultarMenuSinAcceso;
     end;

end;

procedure TMainForm.Usuarios1Click(Sender: TObject);
begin
FrmUsuario.Show();
end;

initialization
  RegisterAppFormClass(TMainForm);

end.
